# OTA(空中下载技术,Over-the-Air Technology)

  空中下载技术（Over-the-Air Technology），是通过移动通信的空中接口实现对移动终端设备及SIM卡数据进行远程管理的技术。经过公网多年的应用与发展，已十分成熟，网络运营商通过OTA技术实现[SIM](https://baike.baidu.com/item/SIM/3437564)卡远程管理，还能提供移动化的新业务下载功能。

通过移动通信的接口实现对软件进行远程管理，传统的做法到4S店通过整车OBD对相应的ECU进行软件升级。

OTA固件升级功能不仅能够更新固件，而且还能重新配置片上硬件资源

OTA技术最早2000年在出现日本，目前通过OTA方式升级软件广泛应用于智能手机。

## 1 架构&流程

**核心**

- 如何接收固件
- 如何保证固件的完整性与合法性
- 如何替换固件(update)

**架构**

- OTA云端
- OTA终端
- OTA设计对象

**流程**

- 生成更新数据包(差分、整分http://www.360doc.com/content/17/1029/15/48650789_699176257.shtml)
- 传输数据包
- 验签
- 安装更新

### 1.1 生成更新数据包

数据包内有要修复的缺陷或者加入的新功能，分发包的更新顺序、更新前和更新后的验证检查等等，都会被打包到这个文件里。生成之后，更新包会被发到一个OTA云服务器平台。在汽车行业，这个平台一般由OEM管理。

### 1.2 传输数据包

车端发出请求到服务器；服务器收到车机请求信息后，发回反馈，要求发送数字证书验证身份。车端发送数字证书到服务器端；服务器对数字证书进行校验是否存在问题；验证无误后终端管理系统向车端发送验证结果，这时开始进行相应的数据传输。更新包会被加密后传输到车端，通过移动网络（3G/4G/5G/WIFI）建立车辆与服务器之间的安全连接，确保数据包安全的传输到车辆TCU，然后再传输给OTA Manager。OTA Manager管理车辆所有ECU的更新过程。

### 1.3 验签

验证是否匹配，安全

**签名**

A给B发送消息，A先计算出消息的消息摘要，然后使用自己的私钥加密消息摘要，被加密的消息摘要就是签名

**验签**

B收到消息后,也会使用和A相同的方法计算消息摘要，然后用A的公钥解密签名，并与自己计算出来的消息

摘要进行比较，如果相同则说明消息是A发送给B的，同时,A也无法否认自己发送消息给B的事实。

(B使用A的公钥解密签名文件的过程，叫做"验签")

![img](https://img-blog.csdnimg.cn/20200906103328791.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2J1bGViaW4=,size_16,color_FFFFFF,t_70)



(这里需要密码学基础概念，什么消息摘要，对称非对称密钥，数字签名啥的)

**固件签名的意义：**

计算hash值可以识别固件是否被篡改和伪装，确保固件的完整性。

使用非对称秘钥签名方便后续验证升级包身份的合法性



### 1.4 安装更新

OTA Manager将数据包分发到ECU，并告知ECU何时执行更新。更新过程完成后，OTA Manager将向服务器发送确认。OTA Manager需要外挂载非易失闪存用来存储车辆ECUs备份，以期在ECU升级失败之后进行调用。这些备份通过加密&认证的方式进行防护以避免外部攻击。这些备份确保汽车在进行OTA升级过程中出现任何意外的情况时，可以恢复到升级之前的状态，从而确保更新失败后的行车安全。

## 2 下载方式

- 短信方式
- 基于浏览器方式
- PUSH方式

### 2.1 短信方式

用户点击移动终端上的“菜单管理”选项发送短消息，向OTA服务器请求下载服务；OTA服务器通过短信方式将下载数据发送给用户的移动终端设备，SIM卡自动完成数据更改。

**优点**是操作较为简便、对网络资源要求低、执行速度快。修改数据打包后一次性下载到SIM卡中，不需要移动终端与网络频繁进行交互，这样既降低了网络负荷，也不必对现网进行改造，使得业务流程简捷易行。

**缺点**是难以承担大量应用数据传输。

### 2.2 基于浏览器方式

用户登陆OTA服务器，查找应用菜单，根据需要从网络后台服务器中下载相应的数据。

**优点**是用户根据需要，主动选择所需业务数据，符合未来发展趋势，可采用GPRS传输方式，传输速率高。

**缺点**是在移动终端设备需要与OTA服务器交互较多的应用数据，对网络资源要求高。

### 2.3 PUSH方式

网络运营者根据业务需要，通过短信或移动邮件方式向终端用户发送新业务数据下载的链接通知，用户点击该链接实现远程自动数据或程序更新。

**优点**是操作简便、业务流程简单，与基于浏览器方式相比，更节省网络资源，不需要移动终端与网络频繁进行交互，传输方式可采用[GPRS](https://baike.baidu.com/item/GPRS/107439)方式，传输速率高。

**缺点**是网络需要根据不同用户有针对性地发送业务数据，对网络资源要求高。



## 3 分类

- FOTA 固件更新(我们要做的肯定是这个，涉及硬件知识)
- SOTA 软件更新

## 4 OTA服务商

- 百度OTA
- 艾拉比(下面有个该服务商的大致流程针对共享单车的OTA升级)

![img](https://5b0988e595225.cdn.sohucs.com/images/20180512/613b9af54f094217a74aea5522116913.jpg)

![img](https://5b0988e595225.cdn.sohucs.com/images/20180512/4a32efe280754475a1beeadd635f6612.jpg)





## 5 OTA带来的好处

1. OTA远程为用户修复软件故障，大幅度缩短中间步骤的时间，使软件快速到达用户，减少汽车制造产商和用户的成本，包括汽车制造产商的召回成本，用户的时间成本；
2. OTA可以为车辆增加新功能，增加用户的新鲜感；
3. OTA拓宽了“服务”和“运营”的范畴，增加车辆的附加价值。

## 6 OTA带来的弊端

 如果OTA改变的只是影音娱乐系统时，带来的只可能是软件层面上的某些bug，不会对司机的安全造成影响，但是当OTA改变的是汽车的核心驱动的时候，影响可能是巨大的。

在OTA发布信息的同时，也有可能会把漏洞和缺陷传播出去，这对车企是一个便利的，但是对坏人也是一种诱惑，有可能实施不正当的hack 攻击。

## 7 OTA设计&挑战

OTA要求主要从安全、时间、版本管控、异常处理方面考虑，具体为：

1. 安全是OTA优先考虑的内容，保证车辆信息安全是当前OTA的一项挑战，必须从硬件、软件、云端几个方面，尤其是三者之间的传输应用来解决。信息安全
2. 软件升级时间最短，就是确保车辆无法行驶的时间最短，车载ECU通常是通过CAN或Ethernet刷写，在带宽允许的情况下，尽可能采取并行刷写模式，选取刷写时间最长的节点优先处理等设计原则。
3. 版本管控版本管控对于OTA来说很重要，因为车辆上ECU众多，不同ECU有不同版本的软件，另外产商的车型众多，不同车型ECU的需求有不同，版本也存在差异。
4. 异常处理方案。在OTA传输过程中，外界干扰或者其他因素导致刷写异常或者中断，车载ECU必须支持软件回滚、断点续传、丢失重传等处理机制

![img](https://img-blog.csdnimg.cn/img_convert/4f5acbe1acd78e22f4a5d38ae99726d0.png)



## 8 需要设备(测试)

- esp8266(wifi串口模块，用于信号传输)

## 9 一些不错的blog

https://www.cnblogs.com/nuoyan/p/11777424.html



## 10 用到OTA的样例

### 10.1 Snoff样例

通过原始OTA机制使用自定义固件刷新Itead Sonoff设备(它提供了一个HTTP和MQTT接口，根本不需要任何到internet的连接)，这个布置场景有点大，里面提到两个例子，一个是通过传感器去计算淋浴出水量的费用(有点闲哈)，还有一个没看。

 这个是Tasmota(是一个固件) https://github.com/arendst/Tasmota，这个链接是从https://github.com/mirko/SonOTA涉及到，然后看过去的。

这是针对snoff的一个OTA升级，Sonoff是ITEAD开发的用于智能家居的智能开关设备系列。该系列中最灵活，最便宜的设备之一是Sonoff Basic和Sonoff mini。这些都是基于Wi-Fi的交换机，基于芯片ESP8266/ESP8285。http://m.elecfans.com/article/1081280.html  & https://remonstrate.wordpress.com/2019/02/03/sonoff-%E4%B9%8B-tasmota-%E5%9B%BA%E4%BB%B6/  & https://blog.nanl.de/2017/05/sonota-flashing-itead-sonoff-devices-via-original-ota-mechanism/这个链接讲了snoff&Tasmota的intro。

**通信**

用到是 tornado这个框架里面调用的一些协议(http和mqtt)传输数据。

**FOR dummies**

然后，这里有个外国友人针对上面的SonOTA写了个傻瓜详细步骤(https://community.home-assistant.io/t/flash-sonota-to-itead-devices-over-wifi-mqtt-control-for-dummies/35774)   ，但还是有dummy在下面说照着做了几个小时还是 fatal。

### 10.2 关于OTA在车方面的应用的Presentation

这个presentation有点长，https://www.youtube.com/watch?v=xNQppkWRGD0

### 10.3 MicroPython 板子

这个是一个关于使用微python 实现OTA的方式更新固件https://schinckel.net/2018/05/26/ota-firmware-updates-with-micropython-esp8266/



这是一种从GitHub存储库更新Micropython微控制器的简单方法，我在基于ESP8266的传感器编队中使用了GitHub存储库。https://dev.to/rangerdigital/simple-ota-updates-for-micropython-with-senko-4lea

**工作原理**

- Senko将微控制器上的选定文件与GitHub存储库中的远程文件同步
- 每次调用.fetch()或.update()方法时，Senko都会比较本地文件和远程文件的SHA1哈希值，以确定它们是否相同。
- 如果它们不是，Senko将远程文件从GitHub存储库保存到你的微控制器。这意味着您需要重新启动以运行最新的代码。

还没看懂。

## 11 结论

一句话解释，发出一个需要更新固件的通知然后发送编译好的加密数据包到对应的设备上实现该设备的整体升级(包括硬件部分)，然后认识了好多硬件。

这中间的每一个环节都不容小觑，尤其是 加密传输以及在设备上刷固件的环节。

这几天墙内墙外都大致看了，墙内的资料较少，墙外的也不是太多(有大部分都是关于手机固件(安卓)的OTA升级)。

整体来说，光看零零散散资料不是太懂(没有ota、硬件基础，要是实现过手机端的OTA的应该看起资料来没有这么吃力)，只知道他有什么步骤、有啥好处。对于具体的实现方式以及实现效果，没有run起来也看不懂看不到。

**ps：**那个在NodeMcu板子上 上刷固件的样例可以尝试一下，这个板子便宜，而且也搭载了ESP8266的wifi可以用于无线传输，大概想法就是，用OTA的方式(暂定用MicroPython语言)在这个NodeMcu的板子实现固件升级，以熟悉OTA流程。

